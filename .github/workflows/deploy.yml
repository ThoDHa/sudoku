name: Test & Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Which tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - go
          - e2e

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "deploy-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # ============================================
  # Frontend Unit Tests (Vitest)
  # ============================================
  test-frontend-unit:
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'unit' || github.event.inputs.test_suite == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run linting
        working-directory: frontend
        run: npm run lint

      - name: Run unit tests
        working-directory: frontend
        run: npm run test:unit
        continue-on-error: true

      - name: Generate environment properties
        working-directory: frontend
        run: |
          echo "node.version=$(node --version)" >> allure-results/environment.properties
          echo "npm.version=$(npm --version)" >> allure-results/environment.properties
          echo "os=$(uname -s)" >> allure-results/environment.properties
          echo "arch=$(uname -m)" >> allure-results/environment.properties
          echo "commit=${{ github.sha }}" >> allure-results/environment.properties
          echo "branch=${{ github.ref_name }}" >> allure-results/environment.properties
          echo "test.type=unit" >> allure-results/environment.properties

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-unit
          path: frontend/allure-results/
          retention-days: 30

  # ============================================
  # Go Tests
  # ============================================
  test-go:
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'go' || github.event.inputs.test_suite == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: api/go.sum

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run Go linter
        working-directory: api
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run ./...

      - name: Run Go tests with JUnit output
        working-directory: api
        run: |
          mkdir -p allure-results
          gotestsum --junitfile allure-results/go-results.xml --format testname -- -v ./...
        continue-on-error: true

      - name: Generate environment properties
        working-directory: api
        run: |
          echo "go.version=$(go version | awk '{print $3}')" >> allure-results/environment.properties
          echo "os=$(uname -s)" >> allure-results/environment.properties
          echo "arch=$(uname -m)" >> allure-results/environment.properties
          echo "commit=${{ github.sha }}" >> allure-results/environment.properties
          echo "branch=${{ github.ref_name }}" >> allure-results/environment.properties
          echo "run.url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> allure-results/environment.properties

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-go
          path: api/allure-results/
          retention-days: 30

  # ============================================
  # Deploy to GitHub Pages (After unit + go)
  # ============================================
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [test-frontend-unit, test-go]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go for WASM build
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: api/go.sum

      # IMPORTANT: TinyGo version must match local development environment (0.40.1)
      # Different TinyGo versions produce incompatible WASM binaries
      # See: https://github.com/tinygo-org/tinygo/releases
      - name: Install TinyGo for WASM build
        run: |
          wget https://github.com/tinygo-org/tinygo/releases/download/v0.40.1/tinygo_0.40.1_amd64.deb
          sudo dpkg -i tinygo_0.40.1_amd64.deb

      - name: Build WASM for deployment
        working-directory: api
        run: make wasm

      - name: Setup Node.js for frontend build
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend for deployment
        working-directory: frontend
        run: npm run build
        env:
          VITE_BASE_PATH: /sudoku/

      - name: Prepare Pages artifact
        run: |
          # Create directory structure for GitHub Pages
          mkdir -p pages-artifact
          cp -r frontend/dist/* pages-artifact/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages-artifact

  # ============================================
  # E2E Full Tests (Runs AFTER deploy - 3h+)
  # ============================================
  test-e2e-full:
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == '' }}
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v2

      - name: Show Docker Compose version
        run: docker compose version

      - name: Run E2E full tests via docker-compose
        run: |
          # Run docker-compose E2E flow. This will build the sudoku image (which includes WASM),
          # start services, run playwright container, and exit with playwright service exit code.
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from playwright
        env:
          CI: true
        continue-on-error: true

      - name: Upload Playwright test-results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results-full
          path: frontend/test-results/
          retention-days: 30

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-full
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload Allure results (if present)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-e2e-full
          path: frontend/allure-results/
          retention-days: 30

  # ============================================
  # Deploy to GitHub Pages (Game + Test Report)
  # ============================================
  deploy-pages:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: allure-report
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================
  # Generate Allure Report (After full E2E)
  # ============================================
  allure-report:
    runs-on: ubuntu-latest
    needs: [test-frontend-unit, test-go, test-e2e-full]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Download all Allure results
        uses: actions/download-artifact@v4
        continue-on-error: false
        with:
          pattern: allure-results-*
          path: allure-results-all
          merge-multiple: false

      - name: Verify results downloaded
        run: |
          echo "Allure-results directory contents:"
          ls -la allure-results/ || echo "Directory empty"
          find allure-results/ -type f | head -20 || echo "No files found"

      - name: Merge Allure results
        run: |
          mkdir -p allure-results
          # Copy all results into single directory
          find allure-results-all -type f \( -name "*.json" -o -name "*.xml" -o -name "*.txt" -o -name "*.png" -o -name "*.attach" -o -name "*.properties" \) -exec cp {} allure-results/ \; 2>/dev/null || true
          # Copy categories.json from frontend for failure classification
          if [ -f "frontend/.allure/categories.json" ]; then
            cp frontend/.allure/categories.json allure-results/
            echo "Copied categories.json for failure classification"
          fi
          echo "Results found:"
          ls -la allure-results/ | grep -E '\.(json|xml|properties)$' || echo "No results found!"

      - name: Download previous Allure history
        uses: actions/download-artifact@v4
        with:
          name: allure-history
          path: allure-history
          continue-on-error: true

      - name: Copy history to results
        run: |
          if [ -d "allure-history" ]; then
            mkdir -p allure-results/history
            cp -r allure-history/* allure-results/history/ 2>/dev/null || true
          fi

      - name: Generate Allure report
        working-directory: frontend
        run: |
          npx allure generate ../allure-results -o ../allure-report --clean

      - name: Prune history to 5 runs (LRU)
        run: |
          if [ -d "allure-report/history" ]; then
            cd allure-report/history
            # Keep only 5 most recent history entries
            ls -t | tail -n +6 | xargs rm -rf2>/dev/null || true
          fi

      - name: Save Allure history
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: allure-report/history/
          retention-days: 90

      - name: Upload Allure report artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30
