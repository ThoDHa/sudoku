# Docker Compose for E2E Testing
# 
# Usage: docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from playwright
#
# The frontend container includes WASM (compiled from Go) - no separate API needed.
# E2E tests exercise the browser-based WASM solver, as users experience it.

services:
  # Sudoku app (nginx serving built app with WASM)
  sudoku:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    ports:
      - "4173:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Go unit tests
  go-tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - ./api:/app/api
      - ./puzzles.json:/data/puzzles.json

  # Frontend unit tests (TypeScript + Vitest)
  frontend-tests:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: >
      sh -c "
        npm ci &&
        npx tsc --noEmit &&
        npm run test:unit &&
        npm run build
      "

  # Playwright E2E test runner
  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-jammy
    working_dir: /app
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      sudoku:
        condition: service_healthy
    environment:
      - PLAYWRIGHT_BASE_URL=http://sudoku:80
      - CI=true
    command: >
      sh -c "
        npm ci &&
        npx playwright install chromium &&
        npx playwright test
      "

volumes: {}
